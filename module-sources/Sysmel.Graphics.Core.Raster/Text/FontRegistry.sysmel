namespace Std definition: {
namespace Graphics definition: {
namespace Core definition: {

#**
 * I am a registry for loaded fonts.
 *#
class FontRegistry definition: {
    private field fontDictionaryMutex type: Std Mutex.
    private field fontDictionary type: Std Collections Dictionary(Std String, Font rcPointer).

    private field fontFaceDictionaryMutex type: Std Mutex.
    private field fontFaceDictionary type: Std Collections Dictionary(Std String, FontFace rcPointer).

    private field defaultSans type: Font rcPointer.
    private field defaultSerif type: Font rcPointer.
    private field defaultMonospaced type: Font rcPointer.

    meta definition: {
        let defaultInstance mutable type: FontRegistry uniquePointer.
        let defaultInstanceOnceCreation mutable type: Std OnceFlag.

        method default => FontRegistry ref := {
            defaultInstanceOnceCreation do: {
                defaultInstance reset: FontRegistry nativeNew.
            }.

            defaultInstance _
        }.
    }.

    method loadFontNamed: (fontName: Std String const ref) with: (fontFillingBlock: ((Font ref) => Void) nativeBlockClosure) ::=> Font rcPointer := {
        fontDictionaryMutex withLock: {
            fontDictionary at: fontName ifAbsentPut: {:: (Font rcPointer) |
                let font mutable := Font rcNew.
                fontFillingBlock(font _).
                font
            }
        }
    }.

    method loadFontFace: (faceFileName: Std String const ref) ::=> FontFace rcPointer := {
        fontFaceDictionaryMutex withLock: {
            fontFaceDictionary at: faceFileName ifAbsentPut: {:: (FontFace rcPointer) |
                FontFaceLoaderRegistry uniqueInstance loadFontFaceFromFileNamed: faceFileName
            }
        }
    }.

    method loadRequiredFontFace: (faceFileName: Std String const ref) ::=> FontFace rcPointer := {
        fontFaceDictionaryMutex withLock: {
            fontFaceDictionary at: faceFileName ifAbsentPut: {:: (FontFace rcPointer) |
                FontFaceLoaderRegistry uniqueInstance loadRequiredFontFaceFromFileNamed: faceFileName
            }
        }
    }.

    method setDefaultSansFont: (font: Font rcPointer const ref) ::=> Void
        := defaultSans := font.

    method defaultSans => Font rcPointer := {
        defaultSans ifNil: {
            defaultSans := self loadFontNamed: "DejaVuSans" asMutableString
                with: {:(Font ref) font :: Void |
                let dejaVuParentFolder := FileSystem resourcesDirectory / "fonts/dejavu/ttf".
                font
                    normalFace: (self loadRequiredFontFace: (dejaVuParentFolder / "DejaVuSans.ttf") fullName asMutableString);
                    boldFace: (self loadRequiredFontFace: (dejaVuParentFolder / "DejaVuSans-Bold.ttf") fullName asMutableString);
                    italicFace: (self loadRequiredFontFace: (dejaVuParentFolder / "DejaVuSans-Oblique.ttf") fullName asMutableString);
                    italicBoldFace: (self loadRequiredFontFace: (dejaVuParentFolder / "DejaVuSans-BoldOblique.ttf") fullName asMutableString).
            }
        }.

        defaultSans.
    }.

    method setDefaultSerifFont: (font: Font rcPointer const ref) ::=> Void
        := defaultSerif := font.

    method defaultSerif => Font rcPointer := {
        defaultSerif ifNil: {
            defaultSerif := self loadFontNamed: "DejaVuSerif" asMutableString
                with: {:(Font ref) font :: Void |
                font
                    normalFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuSerif.ttf" asMutableString);
                    boldFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuSerif-Bold.ttf" asMutableString);
                    italicFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuSerif-Oblique.ttf" asMutableString);
                    italicBoldFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuSerif-BoldOblique.ttf" asMutableString).
            }
        }.

        defaultSerif
    }.

    method setDefaultMonospaced: (font: Font rcPointer const ref) ::=> Void
        := defaultMonospaced := font.

    method defaultMonospaced => Font rcPointer := {
        defaultMonospaced ifNil: {
            defaultMonospaced := self loadFontNamed: "DejaVuMono" asMutableString
                with: {:(Font ref) font :: Void |
                font
                    normalFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuMono.ttf" asMutableString);
                    boldFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuMono-Bold.ttf" asMutableString);
                    italicFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuMono-Oblique.ttf" asMutableString);
                    italicBoldFace: (self loadRequiredFontFace: "resources/fonts/dejavu/ttf/DejaVuMono-BoldOblique.ttf" asMutableString).
            }
        }.

        defaultMonospaced
    }.

}.

}. ## End of namespace Core
}. ## End of namespace Graphics
}. ## End of namespace Std
